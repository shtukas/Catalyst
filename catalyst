#!/usr/bin/ruby

# encoding: UTF-8
require 'json'
require 'date'
require 'colorize'
require 'securerandom'
# SecureRandom.hex    #=> "eb693ec8252cd630102fd0d0fb7c3485"
# SecureRandom.hex(4) #=> "eb693123"
# SecureRandom.uuid   #=> "2d931510-d99f-494a-8c67-87feb05e1594"
require 'fileutils'
# FileUtils.mkpath '/a/b/c'
# FileUtils.cp(src, dst)
# FileUtils.mv 'oldname', 'newname'
# FileUtils.rm(path_to_image)
# FileUtils.rm_rf('dir/to/remove')
require 'digest/sha1'
# Digest::SHA1.hexdigest 'foo'
# Digest::SHA1.file(myFile).hexdigest
require 'find'
require 'digest/sha1'
# Digest::SHA1.hexdigest 'foo'
# Digest::SHA1.file(myFile).hexdigest
require 'drb/drb'
require "/Galaxy/local-resources/Ruby-Libraries/LucilleCore.rb"
require "/Galaxy/LucilleOS/Librarian/Librarian-Exported-Functions.rb"
require_relative "catalyst.rb"
# -----------------------------------------------------------------

# CatalystListingUtils::putslisting()

class CatalystListingUtils
    def self.putslisting()
        positionDisplay = lambda {|standardlp, position|
            if standardlp==position then
                "[* #{"%2d" % position}]"
            else
                "[  #{"%2d" % position}]"
            end
        }
        objectToLineOrdinalListing = lambda {|object, ordinal, position, standardlp|
            "#{positionDisplay.call(standardlp, position)} [#{("%.3f" % ordinal)}] #{CommonsUtils::object2Line_v0(object)[8,CommonsUtils::screenWidth()-28]}"
        }
        objectToLineMainListing = lambda {|object, position, standardlp|
            "#{positionDisplay.call(standardlp, position)} #{CommonsUtils::object2Line_v0(object)[0,CommonsUtils::screenWidth()-9]}"
        }
        objectToGenericLine = lambda {|p, position, standardlp|
            if p["type"]=="ordinal" then
                return objectToLineOrdinalListing.call(p["object"], p["ordinal"], position, standardlp)
            end
            if p["type"]=="main" then
                return objectToLineMainListing.call(p["object"], position, standardlp)
            end            
        }
        standardlp = CommonsUtils::getStandardListingPosition()
        screenleft = CommonsUtils::screenHeight()-7
        structure = CommonsUtils::getUnifiedListing(screenleft)
        while structure.select{|p| p["object"]["metric"] < 0.5 }.size >= 2 do
            structure.pop
        end
        if RequirementsOperator::getCurrentlyUnsatisfiedRequirements().size>0 then
            puts "REQUIREMENTS: OFF: #{RequirementsOperator::getCurrentlyUnsatisfiedRequirements().join(", ")}".yellow
            screenleft = screenleft - 1
        end      
        numberOfOrdinals = structure.select{|p| p["type"]=="ordinal" }.size 
        if numberOfOrdinals>0 then
            screenleft = screenleft - 1
        end
        structure.take(screenleft).each_with_index{|p, index|
            position = index+1
            if numberOfOrdinals>0 and (position-1)==numberOfOrdinals then
                puts ""
            end
            str = objectToGenericLine.call(p, position, standardlp)
            object = p["object"]
            if object["is-running"] then
                str = str.green
            end
            puts str
        }
    end
end

# CatalystInterfaceUtils::cli()

class CatalystInterfaceUtils
    def self.object2Line_v1(object)
        announce = object['announce'].strip
        announce = CommonsUtils::announceWithColor(announce, object)
        defaultExpressionAsString = object["default-expression"] ? object["default-expression"] : ""
        requirements = RequirementsOperator::getObjectRequirements(object['uuid'])
        requirementsAsString = requirements.size>0 ? " ( #{requirements.join(" ")} )" : ''
        part1 = 
            [
                "(#{"%.3f" % object["metric"]})",
                " [#{object["uuid"]}]",
                " #{announce}",
            ].join()
        if object["is-running"] then
            part1 = part1.green
        end
        part2 = 
            [
                "#{requirementsAsString.green}",
                CommonsUtils::object2DonotShowUntilAsString(object),
                " (#{object["commands"].join(" ").red})",
                " \"#{defaultExpressionAsString.green}\""
            ].join()
        part1 + part2
    end
    def self.object2Line_v2_ordinal(object, ordinal)
        announce = object['announce'].strip
        announce = CommonsUtils::announceWithColor(announce, object)
        defaultExpressionAsString = object["default-expression"] ? object["default-expression"] : ""
        requirements = RequirementsOperator::getObjectRequirements(object['uuid'])
        requirementsAsString = requirements.size>0 ? " ( #{requirements.join(" ")} )" : ''
        part1 = 
            [
                "[#{"%.3f" % ordinal}]",
                " [#{object["uuid"]}]",
                " #{announce}",
                "#{requirementsAsString.green}",
                CommonsUtils::object2DonotShowUntilAsString(object),
            ].join()
        if object["is-running"] then
            part1 = part1.green
        end
        part2 = 
            [
                " (#{object["commands"].join(" ").red})",
                " \"#{defaultExpressionAsString.green}\""
            ].join()
        part1 + part2
    end
    def self.cli()
        standardlp = CommonsUtils::getStandardListingPosition()
        listingItem = CommonsUtils::getNthElementOfUnifiedListing(standardlp)
        object = listingItem["object"]

        # --------------------------------------------------------------------------------
        # Sometimes a wave item that is an email, gets deleted by the EmailClients process.
        # In such a case they are still in Flock and should not be showed
        if object["agent-uid"]=="283d34dd-c871-4a55-8610-31e7c762fb0d" then
            if object["schedule"][":wave-emails:"] then
                if !File.exists?(object["item-data"]["folderpath"]) then
                    puts CommonsUtils::object2Line_v0(object)
                    TheFlock::removeObjectIdentifiedByUUID(object["uuid"])
                    EventsManager::commitEventToTimeline(EventsMaker::destroyCatalystObject(object["uuid"]))
                    return
                end
            end
        end
        # --------------------------------------------------------------------------------

        if listingItem["type"]=="main" then
            puts "[#{standardlp}] #{CatalystInterfaceUtils::object2Line_v1(object)}"
        end
        if listingItem["type"]=="ordinal" then
            puts "[#{standardlp}] #{CatalystInterfaceUtils::object2Line_v2_ordinal(object, listingItem["ordinal"])}"
        end
        print "--> "
        command = STDIN.gets().strip
        if command=="." then
            return
        end
        if command=="+" then
            CommonsUtils::setStandardListingPosition(CommonsUtils::getStandardListingPosition()+1)
            return
        end
        if command[0,1] == "!" then
            command = command[1,command.length]
            Ordinals::unregister(object["uuid"])
        end
        if command.start_with?(":") then
            token, rest = StringParser::decompose(command)
            if token==":?" then
                # :? <float> <description, multi-tokens> # creates a text object and give it that ordinal
                ordinal, description = StringParser::decompose(rest)
                xuuid = CommonsUtils::waveInsertNewItemDefaults(description)
                Ordinals::register(xuuid, ordinal.to_f)
                AgentWave::generalFlockUpgrade()
                if listingItem["type"]=="main" then
                    CommonsUtils::setStandardListingPosition(CommonsUtils::getStandardListingPosition()+1)
                end
                return
            end
            if token==":this" then
                if CommonsUtils::isFloat(rest) or CommonsUtils::isInteger(rest) then
                    # :this <float> # register the current object agains the float
                    ordinal = rest.to_f
                    Ordinals::register(object["uuid"], ordinal)
                    if listingItem["type"]=="main" then
                        CommonsUtils::setStandardListingPosition(CommonsUtils::getStandardListingPosition()+1)
                    end
                    return
                end
                if rest=="goto:project" then
                    ProjectsCore::addObjectUUIDToProjectInteractivelyChosen(object["uuid"])
                    return
                end
                return
            end 
            if CommonsUtils::isInteger(token[1,token.size]) then
                position = token[1,token.size].to_i
                if rest.nil? then
                    # :<position>         # set the listing reference point
                    CommonsUtils::setStandardListingPosition([position, 0].max)
                    return
                end
                if rest == "open" then
                    o = CommonsUtils::getNthElementOfUnifiedListing(position)["object"]
                    CommonsUtils::processObjectAndCommand(o, "open")
                    return
                end
                if rest == "done" then
                    o = CommonsUtils::getNthElementOfUnifiedListing(position)["object"]
                    CommonsUtils::processObjectAndCommand(o, "done")
                    return
                end
                if rest.index(" ").nil? then
                    # :<position> <float> # set the ordinal of the object at this position
                    ordinal = rest.to_f
                    object = CommonsUtils::getNthElementOfUnifiedListing(position)["object"]
                    Ordinals::register(object["uuid"], ordinal)
                    return
                end
            end
            return
        end
        command = command.size>0 ? command : ( object["default-expression"] ? object["default-expression"] : "" )
        CommonsUtils::processObjectAndCommand(object, command)
    end
    def self.primaryDisplayLoop(runId)
        loop {
            if !CommonsUtils::isActiveInstance(runId) then
                FlockDiskIO::loadFromEventsTimeline()
            end
            if FKVStore::getOrNull("63ED1643-C6F6-4E30-A968-8FB86D12E23B:#{Time.new.to_s[0,10]}").nil? then
                if TimePointsCore::dueTimeInHours() <= 0 then
                    puts "I am increasing light speed by 10%"
                    CommonsUtils::setLightSpeed(1.1*CommonsUtils::getLightSpeed())
                    LucilleCore::pressEnterToContinue()
                end
                if TimePointsCore::dueTimeInHours() > 4 then
                    puts "I am decreasing light speed by 20%"
                    CommonsUtils::setLightSpeed(0.8*CommonsUtils::getLightSpeed())
                    LucilleCore::pressEnterToContinue()
                end
                FKVStore::set("63ED1643-C6F6-4E30-A968-8FB86D12E23B:#{Time.new.to_s[0,10]}", "done").nil?
            end
            system("clear")
            puts ""
            puts " "*(CommonsUtils::screenWidth()-43) + "Light speed: #{"%8.6f" % CommonsUtils::getLightSpeed()}"
            puts " "*(CommonsUtils::screenWidth()-43) + "Time points ETA: #{ (Time.new + TimePointsCore::dueTimeInHours()*3600).to_s }"
            if ( Time.new.to_i > FKVStore::getOrDefaultValue("7e6a229e-8464-4f33-9b8d-9cfbe5a4af41", "0").to_i ) and CommonsUtils::isLucille18() then
                lines = CatalystDevOps::archivesTimelineGarbageCollection()
                puts "Archives timeline garbage collection: #{lines.size}"
                lines.each{|line|
                    puts "    - #{line}"
                }
                FKVStore::set("7e6a229e-8464-4f33-9b8d-9cfbe5a4af41", Time.new.to_i + Random::rand*86400)
                LucilleCore::pressEnterToContinue()
                next
            end
            if ( Time.new.to_i > FKVStore::getOrDefaultValue("9dcc9a69-cd99-48de-82af-f25d4d382df5", "0").to_i ) and CommonsUtils::isLucille18() then
                lines = CatalystDevOps::eventsTimelineGarbageCollection()
                puts "Events timeline garbage collection: #{lines.size}"
                lines.each{|line|
                    puts "    - #{line}"
                }
                FKVStore::set("9dcc9a69-cd99-48de-82af-f25d4d382df5", Time.new.to_i + Random::rand*86400)
                LucilleCore::pressEnterToContinue()
                next
            end
            if ( Time.new.to_i > FKVStore::getOrDefaultValue("e138267d-2aff-4a34-99bf-e396e0ddb6cb", "0").to_i ) then
                if RequirementsOperator::getCurrentlyUnsatisfiedRequirements().size>0 then
                    puts "REQUIREMENTS OFF: #{RequirementsOperator::getCurrentlyUnsatisfiedRequirements().join(", ")}"
                    LucilleCore::pressEnterToContinue()
                end
                FKVStore::set("e138267d-2aff-4a34-99bf-e396e0ddb6cb", Time.new.to_i + Random::rand*3600*2)
                next
            end
            CatalystListingUtils::putslisting()
            puts ""
            CatalystInterfaceUtils::cli()
            File.open("#{CATALYST_COMMON_DATABANK_FOLDERPATH}/run-identifier.data", "w") {|f| f.write(runId) }
        }
    end
end

runId = SecureRandom.hex

FlockDiskIO::loadFromEventsTimeline()

Thread.new {
    loop {
        if CommonsUtils::isActiveInstance(runId) then
            CommonsUtils::emailSync(false)
        end
        sleep 1200
    }
}

CatalystInterfaceUtils::primaryDisplayLoop(runId)
